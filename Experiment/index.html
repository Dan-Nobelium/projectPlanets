<!DOCTYPE html>
<html>
  <head>
	<title>My experiment</title>
	<script src="jspsych-6.1.0/jspsych.js"></script>
	<link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
	<script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
	<script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
	<script src="jspsych-6.1.0/plugins/planet-response.js"></script>
	
  </head>
  <body>
	<!--<div id='mainDisp'></div>-->
  </body>
  <script>

	//Initialise timeline
	var timeline = [];

	// Define general instructions
	var instr_gen = {
		type: 'html-button-response',
		stimulus: 'General instructions go here.',
		choices: ['Click this button to proceed.'],
	}
	timeline.push(instr_gen);

	// Define pre-block instructions
	var instr_p1 = {
		type: 'html-button-response',
		stimulus: 'Pre-block instructions go here.',
		choices: ['Click this button to proceed.'],
	}
	timeline.push(instr_p1);


	//Define some global variables
	var block_number = 0;
	var trial_number = 0;
	var points = 0;
	var continuousResp = true;
	var nTrialspBlk = 5; //if continuousResp is true though, this doesn't matter
	var nBlocks_p1 = 2;
	var nBlocks_p2 = 3;
	var reset_block_timer = true;

	if (continuousResp){
		var timeAtBlockStart = null;
		//var block_duration = 10 * 1000; //milliseconds
		var nTrialspBlk = 1; //Use some large number to give some sense of indefinite number of trials
	}

	var planet_noship = {
		type: 'planet-response',
		stimulus: ['img/blue.png','img/orange.png'],// jsPsych.timelineVariable('stimulus'),
		stimulus_mouseover: ['img/blueSelect.png','img/orangeSelect.png'],		
		prompt: ['Planet A','Planet B'], //jsPsych.timelineVariable('prompt'),
		ship_stimulus: ['img/ship1.png','img/ship2.png'],//jsPsych.timelineVariable('ship_stimulus'),
		show_ship: true,
		block_duration: 100 * 1000, //in milliseconds
		continuousResp: continuousResp,
		data: {block_type:'planet_noship',
			   block_number:block_number,
			   trial_number:trial_number,
			   },
		on_start: function(trial){
			trial.points = points;
			trial.data.block_number = block_number;
			trial.data.trial_number = trial_number;
			if (continuousResp){
				//At start of block, initialise relevant vars
				if (reset_block_timer){
					timeAtBlockStart = performance.now()
					reset_block_timer = false
				}
			}
		},
		on_finish: function(data){
			points = data.points_total;
			trial_number = data.trial_number;
			trial_number++;
			//console.log('Trial ' + trial_number)
			//Script for continuous response block
			if (continuousResp){
				jsPsych.endCurrentTimeline();
				//console.log('Block duration (' + block_time_elapsed + ' ms) exceeded max time of ' + block_duration + ' ms , moving on to next block.')
				//trial_number = 0;
				reset_block_timer = true;
				block_number = data.block_number;			
				block_number++
				console.log('Block ' + block_number)

				// var block_time_elapsed =  (performance.now() - timeAtBlockStart)				
				// //console.log(block_time_elapsed/1000 + ' seconds')
				// if (block_time_elapsed > block_duration){
				// 	jsPsych.endCurrentTimeline();
				// 	//console.log('Block duration (' + block_time_elapsed + ' ms) exceeded max time of ' + block_duration + ' ms , moving on to next block.')
				// 	//trial_number = 0;
				// 	reset_block_timer = true;
				// 	block_number = data.block_number;			
				// 	block_number++
				// 	console.log('Block ' + block_number)
				//x}				
			} else {
				if (trial_number>=nTrialspBlk){
					trial_number = 0
					reset_block_timer = true;
					block_number = data.block_number;			
					block_number++
					console.log('Block ' + block_number)
				}
			}
				
		}		
	}
	//Loop over specified number of blocks
	for (var i=0; i<nBlocks_p1; i++){
		var block_noship = {
			timeline: [planet_noship],
			repetitions: nTrialspBlk,
		}
		timeline.push(block_noship)
		//value check p1
		var value_p1 = {
			type: 'html-button-response',
			stimulus: 'Value check first phase.',
			choices: ['Click this button to proceed.'],
		}
		var infer_p1 = {
			type: 'html-button-response',
			stimulus: 'Inference check first phase. ',
			choices: ['Click this button to proceed.'],
		}
		
		timeline.push(value_p1);
		timeline.push(infer_p1);
	}
	// Push next block
	// Define pre-block instructions
	var instr_p2 = {
		type: 'html-button-response',
		stimulus: 'Pre-block instructions with pirate warnings? go here.',
		choices: ['Click this button to proceed.'],
	}
	timeline.push(instr_p2);
	//Copy a planet with ship version from noship
	var planet_ship = Object.assign({},planet_noship); //Note that nested objects might not be copied and simply referenced? Be careful when trying to edit nested objects. Will probably need to clone them separately.
	planet_ship.show_ship = true;
	planet_ship.data.block_type = 'planet_ship';
	//planet_ship.shield_charging_time = 2000;
	//planet_ship.ship_attack_time = 6000;
	//planet_ship.ship_attack_damage= 0.2;
	for (var i=0; i<nBlocks_p2; i++){
		var block_ship = {
			timeline: [planet_ship],
			//timeline_variables: test_stim,
			repetitions: nTrialspBlk,
		}
		timeline.push(block_ship)
		//value check p1
		var value_p2 = {
			type: 'html-button-response',
			stimulus: 'Value check second phase.',
			choices: ['Click this button to proceed.'],
		}
		var infer_p2 = {
			type: 'html-button-response',
			stimulus: 'Inference check second phase.',
			choices: ['Click this button to proceed.'],
		}
		
		timeline.push(value_p2);
		timeline.push(infer_p2);
		//block_number++
	}

	// Final page/debrief
	var infer_p2 = {
		type: 'html-button-response',
		stimulus: 'Final page.',
		choices: ['Click this button to proceed.'],
	}

	//Start experiment
	jsPsych.init({
		timeline: timeline,
		preload_images: ['img/signal.png','img/ship1.png','img/ship2.png','img/blue.png','img/blueSelect.png','img/orange.png','img/orangeSelect.png',
						 'img/cursor.png','img/cursordark.png'],
		
		on_finish: function(){
			jsPsych.data.displayData();
		},
		//display_element: 'mainDisp',
	})

  </script>
</html>
